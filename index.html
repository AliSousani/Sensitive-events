<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>ÙˆÙ‚Ø§ÛŒØ¹ Ø­Ø³Ø§Ø³ (Ø³ÛŒÙ†Ú© Ø¨Ø§ Firestore)</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0c101a; --panel:#141a2a; --panel2:#0f1524; --text:#e9efff; --muted:#9aa8c3;
    --border:#253253; --primary:#7aa5ff; --accent:#49dbc8; --danger:#ff6b6b;
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Vazirmatn",system-ui}
  .wrap{max-width:980px;margin:20px auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
  h1{margin:0;font-size:22px;font-weight:900;background:linear-gradient(90deg,#b7c9ff,#bafff5);-webkit-background-clip:text;background-clip:text;color:transparent}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:12px}
  @media(min-width:740px){.cols-2{grid-template-columns:1fr 1fr}.cols-3{grid-template-columns:repeat(3,1fr)}}
  label{display:block;font-size:12px;color:var(--muted);margin:4px 6px}
  select,input,textarea,button{
    width:100%;background:#0f1424;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:10px 12px;font-size:14px;outline:none
  }
  select:focus,input:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(122,165,255,.18)}
  textarea{min-height:110px;resize:vertical}
  .btn{cursor:pointer;border:none;background:linear-gradient(90deg,#7aa5ff,#49dbc8);color:#07121a;font-weight:800}
  .ghost{background:transparent;border:1px dashed var(--border);color:var(--text)}
  .danger{background:linear-gradient(90deg,#ff6b6b,#ffafaf);color:#2b0000;border:none}
  .hint{color:var(--muted);font-size:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{display:inline-flex;gap:8px;align-items:center;background:#1a2138;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px}
  .list{display:grid;gap:10px;margin-top:10px}
  .item{border:1px solid var(--border);background:#10172a;border-radius:12px;padding:12px}
  .top{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .tags{display:flex;gap:6px;flex-wrap:wrap}
  .tag{font-size:11px;background:#172042;border:1px solid #2a3966;border-radius:8px;padding:3px 8px}
  .ok{background:#09321f;border-color:#115534;color:#c9ffe7}
  .bad{background:#3a1414;border-color:#5c2121;color:#ffe1e1}
  .muted{color:var(--muted)}
  .divider{height:1px;background:var(--border);margin:10px 0}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ÙˆÙ‚Ø§ÛŒØ¹ Ø­Ø³Ø§Ø³</h1>
      <div class="row" style="background:#0f1424;border:1px dashed var(--border);padding:8px 12px;border-radius:12px">
        <span class="hint">UID Ù…Ø´ØªØ±Ú©:</span>
        <input id="uidInput" placeholder="Ù…Ø«Ù„Ø§Ù‹ u_r1l5sctiyecme9sclf1" style="width:240px">
        <button id="setUidBtn" class="ghost">ØªÙ†Ø¸ÛŒÙ…</button>
        <button id="genUidBtn" class="ghost">Ø³Ø§Ø®Øª UID</button>
      </div>
    </header>

    <!-- ÙÛŒÙ„ØªØ± Ùˆ Ú¯Ø²Ø§Ø±Ø´ (Ø¨Ø§Ù„Ø§) -->
    <section class="panel">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="chip">Ù†ØªØ§ÛŒØ¬: <b id="count">Û°</b></span>
          <span class="chip">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ: Ø¬Ø¯ÛŒØ¯ â† Ù‚Ø¯ÛŒÙ…</span>
        </div>
        <span class="hint" id="statusHint">â€”</span>
      </div>

      <div class="grid cols-3" style="margin-top:8px">
        <div>
          <label>Ú©Ø§Ø±Ù…Ù†Ø¯</label>
          <select id="fEmployee"><option value="">Ù‡Ù…Ù‡</option></select>
        </div>
        <div>
          <label>Ø³Ø§Ù„</label>
          <select id="fYear"><option value="">Ù‡Ù…Ù‡</option></select>
        </div>
        <div>
          <label>ÙØµÙ„</label>
          <select id="fSeason">
            <option value="">Ù‡Ù…Ù‡</option>
            <option>Ø¨Ù‡Ø§Ø±</option><option>ØªØ§Ø¨Ø³ØªØ§Ù†</option><option>Ù¾Ø§ÛŒÛŒØ²</option><option>Ø²Ù…Ø³ØªØ§Ù†</option>
          </select>
        </div>
      </div>

      <div class="grid cols-3" style="margin-top:8px">
        <div>
          <label>Ù†ÙˆØ¹</label>
          <select id="fKind">
            <option value="">Ù‡Ù…Ù‡</option>
            <option value="Ù…Ø«Ø¨Øª">Ù…Ø«Ø¨Øª</option>
            <option value="Ù…Ù†ÙÛŒ">Ù…Ù†ÙÛŒ</option>
          </select>
        </div>
        <div class="grid" style="grid-template-columns:1fr auto">
          <div>
            <label>Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø´Ø±Ø­</label>
            <input id="fKeyword" placeholder="Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€¦">
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnSearch" class="ghost">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
          </div>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>&nbsp;</label>
            <button id="btnRefresh" class="ghost">â†» ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnClearFilters" class="ghost">ğŸ§¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ</button>
          </div>
        </div>
      </div>

      <div id="results" class="list"></div>
    </section>

    <!-- ÙØ±Ù… Ø«Ø¨Øª Ø±ÙˆÛŒØ¯Ø§Ø¯ -->
    <section class="panel" style="margin-top:12px">
      <h2 style="margin:0 0 8px">Ø«Ø¨Øª Ø±ÙˆÛŒØ¯Ø§Ø¯</h2>
      <div class="grid cols-3">
        <div>
          <label>Ú©Ø§Ø±Ù…Ù†Ø¯</label>
          <select id="employee"></select>
        </div>
        <div>
          <label>Ø³Ø§Ù„</label>
          <select id="year"></select>
        </div>
        <div>
          <label>ÙØµÙ„</label>
          <select id="season">
            <option>Ø¨Ù‡Ø§Ø±</option><option>ØªØ§Ø¨Ø³ØªØ§Ù†</option><option>Ù¾Ø§ÛŒÛŒØ²</option><option>Ø²Ù…Ø³ØªØ§Ù†</option>
          </select>
        </div>
      </div>

      <div class="grid cols-3" style="margin-top:8px">
        <div>
          <label>Ù†ÙˆØ¹</label>
          <select id="kind">
            <option>Ù…Ø«Ø¨Øª</option>
            <option>Ù…Ù†ÙÛŒ</option>
          </select>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>&nbsp;</label>
            <span class="chip">Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†: Ù‡Ø§Ø±Ø¯Ú©Ø¯ Ùˆ Ù…Ø±ØªØ¨</span>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnSave" class="btn">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
          </div>
        </div>
        <div></div>
      </div>

      <div style="margin-top:8px">
        <label>Ø´Ø±Ø­ Ø±ÙˆÛŒØ¯Ø§Ø¯</label>
        <textarea id="desc" placeholder="Ú†Ù‡ Ø§ØªÙØ§Ù‚ÛŒ Ø§ÙØªØ§Ø¯â€¦"></textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnClearForm" class="ghost">ğŸ§½ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
        <span class="hint" id="msg">â€”</span>
      </div>
    </section>
  </div>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script>
    // â”€â”€ 1) Firebase Config (Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø¨Ø§ ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øª Ø³Ø§Ø®ØªÛŒÙ…)
    const firebaseConfig = {
      apiKey: "AIzaSyCI1jW-3NwZtJEXfyx1Pp0lTg9EyM4xwLQ",
      authDomain: "flashcards-7ea58.firebaseapp.com",
      projectId: "flashcards-7ea58",
      storageBucket: "flashcards-7ea58.firebasestorage.app",
      messagingSenderId: "1031346115685",
      appId: "1:1031346115685:web:afe231ee4dab6bf6ffa28c",
      measurementId: "G-VQECY29XS4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // â”€â”€ 2) UID Ù…Ø´ØªØ±Ú© (Ù‡Ù…Ø§Ù† Ú©Ù‡ Ø¯Ø± ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ)
    const uidInput = document.getElementById('uidInput');
    const setUidBtn = document.getElementById('setUidBtn');
    const genUidBtn = document.getElementById('genUidBtn');
    let UID = localStorage.getItem('events_uid') || '';
    if (UID) uidInput.value = UID;
    setUidBtn.onclick = ()=>{ UID = uidInput.value.trim(); if(!UID) return alert('UID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); localStorage.setItem('events_uid', UID); info('UID ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯.'); search(); };
    genUidBtn.onclick = ()=>{ const u='u_'+Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2,7); uidInput.value=u; setUidBtn.click(); };

    // â”€â”€ 3) Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† (Ù‡Ø§Ø±Ø¯Ú©Ø¯ØŒ Ù…Ø±ØªØ¨ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ)
    const EMPLOYEES = [
      "Ø¢Ø²Ø§Ø¯Ù‡ Ø§Ø­Ù…Ø¯ÛŒ",
      "Ø¹Ø§Ø¯Ù„ Ø³Ù‡Ø±Ø§Ø¨ Ø²Ø§Ø¯Ù‡",
      "Ø¹Ù„ÛŒ Ù‚Ø§Ø³Ù…ÛŒ",
      "Ø³Ù…Ø§Ù†Ù‡ Ú¯Ù‡Ø±Ø®ÙˆØ§Ù‡",
      "Ø³Ù…ÛŒÙ‡ Ø­ÛŒØ¯Ø±ÛŒ",
      "Ø³ÛŒØ¯ ØµÙ„Ø§Ø­ Ø­Ø³ÛŒÙ†ÛŒ",
      "Ø³ÛŒØ¯ Ù…Ø­Ù…Ø¯Ù‡Ø§Ø¯ÛŒ Ù…Ù‚ÛŒÙ…ÛŒ",
      "Ø³Ù¾ÛŒØ¯Ù‡ ØªÙØ±Ø´ÛŒ",
      "ÙØ§Ø·Ù…Ù‡ Ø¨Ø®Ø´Ù†Ø¯Ù‡",
      "Ù…Ø­Ù…Ø¯Ø±Ø¶Ø§ Ø´ÛŒØ±Ø§Ø²ÛŒ",
      "Ù…Ø­Ù…Ø¯Ø­Ø³ÛŒÙ† Ø¹Ù„ÛŒØ²Ø§Ø¯Ù‡",
      "Ù…Ø­Ù…Ø¯ÙˆÙ„ÛŒ Ù¾ÙˆØ±Ø§ÙˆÙ†Ø¯",
      "Ù…Ù‡Ù†Ø§Ø² Ø±Ø­Ù…Ø§Ù†ÛŒ Ù†Ú˜Ø§Ø¯",
      "Ù…Ù‡Ø¯ÛŒÙ‡ Ù†ÛŒØ±ÛŒ"
    ];
    function fillEmployees(){
      const els = [document.getElementById('employee'), document.getElementById('fEmployee')];
      els.forEach((sel, i)=>{
        sel.innerHTML = i===1 ? '<option value=\"\">Ù‡Ù…Ù‡</option>' : '';
        EMPLOYEES.forEach(n=> sel.add(new Option(n, n)));
      });
    }

    // â”€â”€ 4) Ø³Ø§Ù„â€ŒÙ‡Ø§
    function fillYears(){
      const ySel = document.getElementById('year');
      const fySel= document.getElementById('fYear');
      const years = [];
      for(let y=1395;y<=1410;y++) years.push(y);
      ySel.innerHTML=''; fySel.innerHTML='<option value=\"\">Ù‡Ù…Ù‡</option>';
      years.forEach(y=>{
        ySel.add(new Option(String(y), y));
        fySel.add(new Option(String(y), y));
      });
      ySel.value = 1404;
    }

    // â”€â”€ 5) Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯
    const msg = document.getElementById('msg');
    function info(t){ msg.textContent=t; setTimeout(()=>msg.textContent='â€”',1600); }
    document.getElementById('btnSave').onclick = async ()=>{
      if(!UID) return alert('Ø§ÙˆÙ„ UID Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.');
      const employee = document.getElementById('employee').value;
      const year     = Number(document.getElementById('year').value);
      const season   = document.getElementById('season').value;
      const kind     = document.getElementById('kind').value; // Ù…Ø«Ø¨Øª/Ù…Ù†ÙÛŒ
      const desc     = (document.getElementById('desc').value||'').trim();
      if(!employee) return info('Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
      if(!desc) return info('Ø´Ø±Ø­ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.');
      try{
        await db.collection('users').doc(UID).collection('events').add({
          employee, year, season, kind, desc,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('desc').value='';
        info('âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
        await search(); // ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú¯Ø²Ø§Ø±Ø´
      }catch(e){ console.error(e); info('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡.'); }
    };
    document.getElementById('btnClearForm').onclick = ()=>{
      document.getElementById('desc').value='';
      document.getElementById('kind').value='Ù…Ø«Ø¨Øª';
    };

    // â”€â”€ 6) Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ/Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù‡Ù…Ù‡ ÙÛŒÙ„ØªØ±Ù‡Ø§
    const countEl = document.getElementById('count');
    const results = document.getElementById('results');
    const statusHint = document.getElementById('statusHint');

    document.getElementById('btnSearch').onclick = search;
    document.getElementById('btnRefresh').onclick = search;
    document.getElementById('btnClearFilters').onclick = ()=>{
      document.getElementById('fEmployee').value='';
      document.getElementById('fYear').value='';
      document.getElementById('fSeason').value='';
      document.getElementById('fKind').value='';
      document.getElementById('fKeyword').value='';
      search();
    };

    function rowHtml(id, d){
      const date = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString('fa-IR') : 'â€”';
      const tagKind = d.kind==='Ù…Ù†ÙÛŒ' ? 'tag bad">Ù…Ù†ÙÛŒ' : 'tag ok">Ù…Ø«Ø¨Øª';
      return `
        <div class="item">
          <div class="top">
            <div class="tags">
              <span class="tag">${d.employee||'â€”'}</span>
              <span class="tag">${d.year||'â€”'}</span>
              <span class="tag">${d.season||'â€”'}</span>
              <span class="${tagKind}</span>
            </div>
            <div class="muted">${date}</div>
          </div>
          <div class="divider"></div>
          <div>${(d.desc||'').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')}</div>
          <div class="row" style="margin-top:8px">
            <button class="ghost" onclick="__edit('${id}')">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ â†’ Ù¾Ø± Ø´Ø¯Ù† ÙØ±Ù…</button>
            <button class="danger" onclick="__del('${id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            <span class="hint">ID: ${id}</span>
          </div>
        </div>`;
    }

    async function search(){
      if(!UID){ statusHint.textContent='UID Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.'; return; }
      statusHint.textContent='Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦';

      const fEmp = document.getElementById('fEmployee').value;
      const fYear= document.getElementById('fYear').value;
      const fSea = document.getElementById('fSeason').value;
      const fKind= document.getElementById('fKind').value;
      const kw   = document.getElementById('fKeyword').value.trim().toLowerCase();

      let q = db.collection('users').doc(UID).collection('events').orderBy('createdAt','desc');
      if(fEmp)  q = q.where('employee','==',fEmp);
      if(fYear) q = q.where('year','==',Number(fYear));

      const snap = await q.limit(500).get();
      let docs = snap.docs.map(d=>({id:d.id, ...d.data()}));

      if(fSea)  docs = docs.filter(x=>x.season===fSea);
      if(fKind) docs = docs.filter(x=>x.kind===fKind);
      if(kw)    docs = docs.filter(x=>(x.desc||'').toLowerCase().includes(kw));

      results.innerHTML = docs.map(d=>rowHtml(d.id, d)).join('') || '<div class="hint">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</div>';
      countEl.textContent = String(docs.length);
      statusHint.textContent='Ø¢Ù…Ø§Ø¯Ù‡.';
    }

    // Ø­Ø°Ù Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ (Ù†Ø±Ù…)
    window.__del = async function(id){
      if(!UID) return alert('UID Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.');
      if(!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      await db.collection('users').doc(UID).collection('events').doc(id).delete();
      search();
    }
    window.__edit = async function(id){
      if(!UID) return alert('UID Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.');
      const doc = await db.collection('users').doc(UID).collection('events').doc(id).get();
      if(!doc.exists) return;
      const d = doc.data();
      document.getElementById('employee').value = d.employee||'';
      document.getElementById('year').value     = d.year||1404;
      document.getElementById('season').value   = d.season||'Ø¨Ù‡Ø§Ø±';
      document.getElementById('kind').value     = d.kind||'Ù…Ø«Ø¨Øª';
      document.getElementById('desc').value     = d.desc||'';
      info('ğŸ”„ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø± ÙØ±Ù… Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª (Ø°Ø®ÛŒØ±Ù‡ = Ø«Ø¨Øª Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡).');
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }

    // init
    function boot(){ fillEmployees(); fillYears(); search(); }
    boot();
  </script>
</body>
</html>
