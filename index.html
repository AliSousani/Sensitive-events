<!doctype html>
<html lang="fa" dir="rtl"> 
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ÙˆÙ‚Ø§ÛŒØ¹ Ø­Ø³Ø§Ø³</title>
  <!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ Ø´ÛŒÚ© -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;--card:#121936;--muted:#94a3b8;--text:#e8eefc;--primary:#7c9aff;
      --ok:#16a34a;--bad:#ef4444;--chip:#223066;--chip2:#1d243f;
      --accent:#f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#060a16, #0b1020 20%, #0b1020);
      color:var(--text); font-family:"Vazirmatn",system-ui; line-height:1.7;
    }
    .wrap{max-width:980px;margin:20px auto;padding:16px}
    .title{
      display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 2px 18px
    }
    .title h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
    .kebab{opacity:.6}
    .grid{display:grid;gap:12px}
    @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:repeat(3,1fr)}}
    .card{
      background:radial-gradient(1200px 400px at 120% -15%,rgba(124,154,255,.08), transparent 40%), var(--card);
      border:1px solid #1f2a52;border-radius:16px;padding:14px 14px 16px; box-shadow:0 8px 30px rgba(2,8,23,.35);
    }
    .card h2{font-size:14px;margin:0 0 10px;color:#b8c7ff;font-weight:700}
    label{font-size:12px;color:var(--muted);display:block;margin:4px 6px}
    select,input,textarea,button{
      width:100%;border-radius:12px;border:1px solid #24305b;background:#0e1533;color:var(--text);
      padding:10px 12px;font-family:inherit;font-size:14px;outline:none
    }
    select:focus,input:focus,textarea:focus{border-color:#3b82f6; box-shadow:0 0 0 2px rgba(59,130,246,.25)}
    .row{display:flex;gap:8px;align-items:center}
    .btn{cursor:pointer;background:linear-gradient(180deg,#3b82f6,#2563eb);border:none}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:#0f1637;border:1px dashed #2c3665}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid #2d3b73;
      color:#cbd5ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .small{font-size:12px;color:var(--muted)}
    .list{display:grid;gap:10px;margin-top:10px}
    .item{border:1px solid #233064;background:linear-gradient(180deg,#121b40,#0d1433);border-radius:12px;padding:12px}
    .tag{font-size:11px;color:#9db0ff;background:#1b2652;border:1px solid #28356a;border-radius:8px;padding:3px 8px;margin-left:6px}
    .ok{color:#d1fae5;background:#062716;border:1px solid #0b3a1f}
    .bad{color:#ffe1e1;background:#3a0b0b;border:1px solid #5c1414}
    .row-spread{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .danger{background:linear-gradient(180deg,#ef4444,#b91c1c)}
    .muted{opacity:.8}
    .uidBox{display:flex; gap:8px}
    .divider{height:1px;background:#1f2a52;margin:8px 0}
    .pill{background:#1c244a;border:1px solid #2b3a72;color:#cfe1ff;border-radius:999px;padding:6px 10px;font-size:12px}
    .accent{color:#fde68a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1>ğŸ“Œ ÙˆÙ‚Ø§ÛŒØ¹ Ø­Ø³Ø§Ø³</h1>
      <div class="kebab small">Ù†Ø³Ø®Ù‡ Û±.Û°</div>
    </div>

    <!-- Ù†Ù…Ø§ÛŒØ´ Ùˆ ÙÛŒÙ„ØªØ± Ù†ØªØ§ÛŒØ¬ (Ø¨Ø§Ù„Ø§) -->
    <div class="card">
      <h2>Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</h2>
      <div class="grid grid-3">
        <div>
          <label>Ú©Ø§Ø±Ù…Ù†Ø¯</label>
          <select id="fEmployee">
            <option value="">Ù‡Ù…Ù‡</option>
          </select>
        </div>
        <div>
          <label>Ø³Ø§Ù„</label>
          <select id="fYear">
            <option value="">Ù‡Ù…Ù‡</option>
          </select>
        </div>
        <div>
          <label>ÙØµÙ„</label>
          <select id="fSeason">
            <option value="">Ù‡Ù…Ù‡</option>
            <option>Ø¨Ù‡Ø§Ø±</option><option>ØªØ§Ø¨Ø³ØªØ§Ù†</option><option>Ù¾Ø§ÛŒÛŒØ²</option><option>Ø²Ù…Ø³ØªØ§Ù†</option>
          </select>
        </div>
      </div>
      <div class="grid grid-3" style="margin-top:10px">
        <div>
          <label>Ù†ÙˆØ¹</label>
          <select id="fSent">
            <option value="">Ù‡Ù…Ù‡</option>
            <option value="pos">Ù…Ø«Ø¨Øª</option>
            <option value="neg">Ù…Ù†ÙÛŒ</option>
          </select>
        </div>
        <div class="grid" style="grid-template-columns:1fr auto">
          <div>
            <label>Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø´Ø±Ø­</label>
            <input id="fKeyword" placeholder="Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€¦" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnSearch" class="btn">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
          </div>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>&nbsp;</label>
            <button id="btnRefresh" class="ghost">â†» ØªØ§Ø²Ù‡â€ŒØ³Ø§Ø²ÛŒ</button>
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnClearFilters" class="ghost">ğŸ§¹ Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <span class="chip">ØªØ¹Ø¯Ø§Ø¯ Ù†ØªØ§ÛŒØ¬: <b id="count">Û°</b></span>
        <span class="chip">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ: Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† â† Ù‚Ø¯ÛŒÙ…ÛŒ</span>
      </div>
      <div id="results" class="list"></div>
    </div>

    <!-- ÙØ±Ù… ÙˆØ±ÙˆØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª -->
    <div class="grid grid-2" style="margin-top:14px">
      <div class="card">
        <h2>Ø§ÙØ²ÙˆØ¯Ù†/Ø«Ø¨Øª Ø±ÙˆÛŒØ¯Ø§Ø¯</h2>

        <div class="grid grid-3">
          <div>
            <label>Ú©Ø§Ø±Ù…Ù†Ø¯</label>
            <select id="employee"></select>
          </div>
          <div>
            <label>Ø³Ø§Ù„</label>
            <select id="year"></select>
          </div>
          <div>
            <label>ÙØµÙ„</label>
            <select id="season">
              <option>Ø¨Ù‡Ø§Ø±</option><option>ØªØ§Ø¨Ø³ØªØ§Ù†</option><option>Ù¾Ø§ÛŒÛŒØ²</option><option>Ø²Ù…Ø³ØªØ§Ù†</option>
            </select>
          </div>
        </div>

        <div class="grid grid-3" style="margin-top:10px">
          <div>
            <label>Ù†ÙˆØ¹</label>
            <select id="sentiment">
              <option value="pos">Ù…Ø«Ø¨Øª</option>
              <option value="neg">Ù…Ù†ÙÛŒ</option>
            </select>
          </div>
          <div class="grid" style="grid-template-columns:1fr auto">
            <div>
              <label>Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯</label>
              <input id="newEmp" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ù…Ù†Ø¯â€¦" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="btnAddEmp" class="ghost">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
            </div>
          </div>
          <div>
            <label>&nbsp;</label>
            <span class="pill">Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø¨ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</span>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Ø´Ø±Ø­ Ø±ÙˆÛŒØ¯Ø§Ø¯</label>
          <textarea id="desc" rows="4" placeholder="Ú†Ù‡ Ø§ØªÙØ§Ù‚ÛŒ Ø§ÙØªØ§Ø¯â€¦"></textarea>
        </div>

        <div class="row" style="gap:8px;margin-top:12px">
          <button id="btnSave" class="btn">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
          <button id="btnClearForm" class="ghost">ğŸ§½ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…</button>
        </div>

        <div class="small muted" id="msg" style="margin-top:8px"></div>
      </div>

      <!-- ØªÙ†Ø¸ÛŒÙ… Ø´Ù†Ø§Ø³Ù‡ Ù…Ø´ØªØ±Ú© -->
      <div class="card">
        <h2>Ø´Ù†Ø§Ø³Ù‡Ù” Ù…Ø´ØªØ±Ú© (UID)</h2>
        <div class="small" style="margin-bottom:8px">
          Ù‡Ù…Ù‡â€ŒÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø¨Ø§ <span class="accent">UID</span> Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ Ù‡Ù…Ú¯Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.
          Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øª UID ØªÙ†Ø¸ÛŒÙ… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‡Ù…Ø§Ù† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†ÛŒØ² Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ù‡Ø± Ø¯Ùˆ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø´ØªØ±Ú© Ø¨Ø§Ø´Ø¯.
        </div>
        <div class="uidBox">
          <input id="uid" placeholder="Ù…Ø«Ù„Ø§Ù‹: u_r1l5sctiyecme9sclf1" />
          <button id="btnSetUID" class="ghost">ØªÙ†Ø¸ÛŒÙ…</button>
          <button id="btnGenUID" class="ghost">Ø³Ø§Ø®Øª UID</button>
        </div>
        <div class="small muted" id="uidInfo" style="margin-top:8px"></div>

        <div class="divider"></div>
        <h2 style="margin-top:2px">Ø±Ø§Ù‡Ù†Ù…Ø§</h2>
        <ul class="small" style="margin:6px 16px 0; padding:0 16px">
          <li>Ø§ÙˆÙ„ <b>UID</b> Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øª Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯).</li>
          <li>Ù„ÛŒØ³Øª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† Ø±Ø§ ÛŒÚ© Ø¨Ø§Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯Ø› Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù† Ø§Ø² Ù…Ù†ÙˆÛŒ Ú©Ø´ÙˆÛŒÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</li>
          <li>Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨Ø®Ø´ Â«Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§Â» Ø¯Ø± Ø¨Ø§Ù„Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Firebase (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // -------------------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Firebase --------------------
    // TODO: Ø§ÛŒÙ†Ø¬Ø§ Ú©Ø§Ù†ÙÛŒÚ¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø®ÙˆØ¯Øª Ø±Ø§ Ø¨Ú¯Ø°Ø§Ø± (Ø§Ø² Settings â†’ General â†’ Your apps â†’ Web app)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    // -----------------------------------------------------------
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Ø¹Ù†Ø§ØµØ±
    const el = id => document.getElementById(id);

    const uidInput = el('uid');
    const uidInfo  = el('uidInfo');
    const employee = el('employee');
    const year     = el('year');
    const season   = el('season');
    const sentiment= el('sentiment');
    const desc     = el('desc');
    const msg      = el('msg');

    const fEmployee= el('fEmployee');
    const fYear    = el('fYear');
    const fSeason  = el('fSeason');
    const fSent    = el('fSent');
    const fKeyword = el('fKeyword');
    const results  = el('results');
    const count    = el('count');

    // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ø§Ù„â€ŒÙ‡Ø§ (Û±Û´Û°Û° ØªØ§ Û±Û´Û±Ûµ)
    const years = Array.from({length: 16}, (_,i) => 1400+i);
    years.forEach(y=>{
      const o1 = new Option(String(y), y); year.add(o1.cloneNode(true));
      const o2 = new Option(String(y), y); fYear.add(o2);
    });
    // Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø³Ø§Ù„ Ø¬Ø§Ø±ÛŒ Ø´Ù…Ø³ÛŒ
    try{
      const now = new Date();
      // ØªÙ‚Ø±ÛŒØ¨: Ø³Ø§Ù„ Ø´Ù…Ø³ÛŒ ~ Ù…ÛŒÙ„Ø§Ø¯ÛŒ-621 ÛŒØ§ -622ØŒ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ:
      const gy = now.getFullYear(), gm = now.getMonth()+1;
      let jy = gy - 621; if(gm<3) jy--; // ØªØ®Ù…ÛŒÙ†ÛŒ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ UI
      year.value = years.includes(jy)? jy: years.at(-1);
    }catch{ year.value = years[0]; }

    // UID
    const UID_KEY = 'sensitive_uid';
    function setUID(u){
      localStorage.setItem(UID_KEY, u);
      uidInput.value = u;
      uidInfo.textContent = u ? `UID ÙØ¹Ù„ÛŒ: ${u}` : 'Ù‡Ù†ÙˆØ² ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.';
    }
    function getUID(){ return uidInput.value.trim(); }

    // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ UID Ø§Ø² localStorage ÛŒØ§ Ø§Ø² ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øª (Ø§Ú¯Ø± Ù‡Ù…Ø§Ù† Ø¯Ø§Ù…Ù†Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
    (function initUID(){
      const fromLocal = localStorage.getItem(UID_KEY);
      if(fromLocal){ setUID(fromLocal); return; }
      // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø² ÙÙ„Ø´â€ŒÚ©Ø§Ø±Øª (Ø§Ú¯Ø± Ù‡Ù…Ø§Ù† Ú©Ù„ÛŒØ¯ Ø±Ø§ Ø¯Ø§Ø´ØªÛŒØ¯)
      const flashKey = 'flashcards_uid';
      const fromFlash = localStorage.getItem(flashKey);
      if(fromFlash){ setUID(fromFlash); return; }
      uidInfo.textContent = 'Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ© UID ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø³Ø§Ø²ÛŒØ¯.';
    })();

    el('btnSetUID').onclick = ()=> setUID(uidInput.value.trim());
    el('btnGenUID').onclick = ()=>{
      const u = 'u_'+Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2,7);
      setUID(u);
    };

    // ---------- Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù† (sync Ø¯Ø± Ú©Ù„Ø§ÛŒÙˆØ¯) ----------
    const empSelects = [employee, fEmployee];
    function fillEmployees(options){
      empSelects.forEach(sel=>{
        const val = sel.value;
        sel.innerHTML = '';
        if(sel === fEmployee) sel.add(new Option('Ù‡Ù…Ù‡',''));
        options.forEach(n=> sel.add(new Option(n, n)));
        if(val) sel.value = val;
      });
    }
    async function loadEmployees(){
      const uid = getUID(); if(!uid) return;
      const snap = await db.collection('employees')
        .where('uid','==',uid)
        .orderBy('name')
        .get();
      const names = snap.docs.map(d=>d.data().name);
      if(names.length===0){
        // Ø§Ú¯Ø± Ú†ÛŒØ²ÛŒ Ù†Ø¨ÙˆØ¯ØŒ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡Ù” Ø®Ø§Ù„ÛŒ
        fillEmployees(['']);
      }else{
        fillEmployees(names);
      }
    }
    el('btnAddEmp').onclick = async ()=>{
      const uid = getUID();
      const name = el('newEmp').value.trim();
      if(!uid) return alert('Ø§ÙˆÙ„ UID Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.');
      if(!name) return;
      // Ø¹Ø¯Ù… ØªÚ©Ø±Ø§Ø±
      const exists = await db.collection('employees')
        .where('uid','==',uid).where('name','==',name).limit(1).get();
      if(!exists.empty){
        el('newEmp').value=''; await loadEmployees(); employee.value=name; fEmployee.value=name;
        return;
      }
      await db.collection('employees').add({uid, name, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
      el('newEmp').value='';
      await loadEmployees();
      employee.value = name; fEmployee.value = name;
    };

    // ---------- Ø°Ø®ÛŒØ±Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯ ----------
    el('btnSave').onclick = async ()=>{
      const uid = getUID();
      if(!uid) return alert('UID Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.');
      const data = {
        uid,
        employee: employee.value,
        year: Number(year.value),
        season: season.value,
        sentiment: sentiment.value, // pos/neg
        desc: (desc.value||'').trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      if(!data.employee){ msg.textContent='Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.'; return; }
      if(!data.desc){ msg.textContent='Ø´Ø±Ø­ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.'; return; }

      el('btnSave').disabled = true;
      try{
        await db.collection('events').add(data);
        msg.textContent='âœ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.';
        desc.value='';
        // Ø±ÙØ±Ø´ Ù„ÛŒØ³Øª
        await search();
      }catch(e){
        console.error(e);
        msg.textContent='âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡.';
      }finally{
        el('btnSave').disabled = false;
      }
    };
    el('btnClearForm').onclick = ()=>{
      desc.value=''; sentiment.value='pos';
    };

    // ---------- Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ùˆ Ù†Ù…Ø§ÛŒØ´ ----------
    function renderItem(doc){
      const d = doc.data();
      const time = d.createdAt?.toDate?.() || null;
      const dateStr = time ? time.toLocaleString('fa-IR') : 'â€”';

      const wrap = document.createElement('div');
      wrap.className='item';

      const tags = `
        <span class="tag">${d.employee||'â€”'}</span>
        <span class="tag">${d.year||'â€”'}</span>
        <span class="tag">${d.season||'â€”'}</span>
        <span class="tag ${d.sentiment==='pos'?'ok':'bad'}">${d.sentiment==='pos'?'Ù…Ø«Ø¨Øª':'Ù…Ù†ÙÛŒ'}</span>
      `;
      wrap.innerHTML = `
        <div class="row-spread">
          <div>${tags}</div>
          <div class="small muted">${dateStr}</div>
        </div>
        <div style="margin-top:8px">${(d.desc || '').replace(/\n/g,'<br>')}</div>
        <div class="row" style="gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="ghost" data-act="edit">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button>
          <button class="danger" data-act="del">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          <span class="chip">Ø´Ù†Ø§Ø³Ù‡ Ø³Ù†Ø¯: <span class="accent">${doc.id}</span></span>
        </div>
      `;
      // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
      wrap.querySelector('[data-act="del"]').onclick = async ()=>{
        if(!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
        await db.collection('events').doc(doc.id).delete();
        await search();
      };
      wrap.querySelector('[data-act="edit"]').onclick = ()=>{
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ ÙØ±Ù…
        employee.value = d.employee||'';
        year.value = d.year||'';
        season.value = d.season||'Ø¨Ù‡Ø§Ø±';
        sentiment.value = d.sentiment||'pos';
        desc.value = d.desc||'';
        msg.textContent = 'ğŸ”„ Ø¯Ø§Ø¯Ù‡ Ø¯Ø± ÙØ±Ù… Ù‚Ø±Ø§Ø± Ú¯Ø±ÙØª. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ØµÙ„Ø§Ø­ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯ (Ø°Ø®ÛŒØ±Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯).';
        window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
      };
      return wrap;
    }

    async function search(){
      const uid = getUID(); if(!uid) return;
      // Ø³Ø§Ø®Øª query Ù¾Ø§ÛŒÙ‡
      let q = db.collection('events').where('uid','==',uid).orderBy('createdAt','desc').limit(200);

      // ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø¨Ø±Ø§Ø¨Ø±
      const emp = fEmployee.value;
      const yr  = fYear.value;
      const ssn = fSeason.value;
      const st  = fSent.value;

      // Firestore Ø¨Ø±Ø§ÛŒ ØªØ±Ú©ÛŒØ¨ where Ø¨Ù‡ Ø§ÛŒÙ†Ø¯Ú©Ø³ Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ù‡Ø›
      // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒØŒ ÙÙ‚Ø· whereÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ùˆ Ø¨Ù‚ÛŒÙ‡ Ø±Ø§ Ú©Ù„Ø§ÛŒÙ†ØªÛŒ ÙÛŒÙ„ØªØ± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
      if(emp) q = q.where('employee','==',emp);
      if(yr)  q = q.where('year','==',Number(yr));
      if(ssn) q = q.where('season','==',ssn);
      if(st)  q = q.where('sentiment','==',st);

      const snap = await q.get();
      let docs = snap.docs;

      // ÙÛŒÙ„ØªØ± Ú©Ù„Ù…Ù‡ Ú©Ù„ÛŒØ¯ÛŒ Ø±ÙˆÛŒ Ú©Ù„Ø§ÛŒÙ†Øª
      const kw = fKeyword.value.trim();
      if(kw){
        const p = kw.toLowerCase();
        docs = docs.filter(d => (d.data().desc||'').toLowerCase().includes(p));
      }

      results.innerHTML='';
      docs.forEach(d => results.appendChild(renderItem(d)));
      count.textContent = String(docs.length);
    }

    el('btnSearch').onclick = search;
    el('btnRefresh').onclick = search;
    el('btnClearFilters').onclick = ()=>{
      fEmployee.value='';
      fYear.value='';
      fSeason.value='';
      fSent.value='';
      fKeyword.value='';
      search();
    };

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    (async function init(){
      await loadEmployees();
      if(employee.options.length===0) employee.add(new Option('',''));
      await search();
    })();
  </script>
</body>
</html>
